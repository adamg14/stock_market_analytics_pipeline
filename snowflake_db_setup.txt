USE ROLE USERADMIN;
CREATE ROLE IF NOT EXISTS STOCK_DATABASE_ADMIN;

CREATE USER IF NOT EXISTS STOCK_DATABASE_MANAGER
PASSWORD = '**********'
DEFAULT_ROLE = STOCK_DATABASE_ADMIN
DEFAULT_WAREHOUSE = STOCK_DATA_WAREHOUSE;

GRANT ROLE STOCK_DATABASE_ADMIN TO USER STOCK_DATABASE_MANAGER;
GRANT ROLE  STOCK_DATABASE_ADMIN TO USER **********;

USE ROLE SYSADMIN;

CREATE WAREHOUSE IF NOT EXISTS STOCK_DATA_WAREHOUSE;
USE WAREHOUSE STOCK_DATA_WAREHOUSE;
CREATE DATABASE IF NOT EXISTS STOCK_DB;
CREATE SCHEMA IF NOT EXISTS STOCK_DB.MARKET_DATA_SCHEMA;

CREATE OR REPLACE TABLE STOCK_DB.MARKET_DATA_SCHEMA.RAW_PRICES(
    ticker STRING,
    price_interval STRING,
    currency STRING,
    exchange_timezone STRING,
    datetime_stamp TIMESTAMP,
    open_price FLOAT,
    high_price FLOAT,
    low_price FLOAT,
    close_price FLOAT,
    volume_price FLOAT,
    load_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
);

GRANT USAGE ON WAREHOUSE STOCK_DATA_WAREHOUSE TO ROLE STOCK_DATABASE_ADMIN;
GRANT USAGE ON DATABASE STOCK_DB TO ROLE STOCK_DATABASE_ADMIN;
GRANT USAGE ON SCHEMA MARKET_DATA_SCHEMA TO ROLE STOCK_DATABASE_ADMIN;

GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA STOCK_DB.MARKET_DATA_SCHEMA TO ROLE STOCK_DATABASE_ADMIN;

GRANT CREATE TABLE, CREATE VIEW ON SCHEMA STOCK_DB.MARKET_DATA_SCHEMA TO ROLE STOCK_DATABASE_ADMIN;
GRANT MODIFY ON WAREHOUSE STOCK_DATA_WAREHOUSE TO ROLE STOCK_DATABASE_ADMIN;

-- TEST
USE ROLE STOCK_DATABASE_ADMIN;
SHOW TABLES IN SCHEMA STOCK_DB.MARKET_DATA_SCHEMA;

-- Adding the public key 
USE ROLE SECURITYADMIN;
ALTER USER STOCK_DATABASE_MANAGER SET RSA_PUBLIC_KEY = '*******';